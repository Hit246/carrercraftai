
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read their own user document and admins can read/write any.
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      // Allow admins to update user plans
      allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan == 'recruiter' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == 'admin@careercraft.ai' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == 'hitarth0236@gmail.com';
      // Allow admins to delete users
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan == 'recruiter' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == 'admin@careercraft.ai' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == 'hitarth0236@gmail.com';
    }

    // Users can read and write their own resume.
    match /resumes/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Team management rules
    match /teams/{teamId} {
      allow read, create: if request.auth != null;
      
      // Team members can be read by team members, and managed by the owner.
      match /members/{memberId} {
        // Anyone authenticated can be added to a team (invited)
        allow create: if request.auth != null; 
        // Allow read if the user is part of the team's parent document
        allow read: if request.auth != null && get(/databases/$(database)/documents/teams/$(teamId)).data.owner == request.auth.uid;
         // Allow delete only by the team owner
        allow delete: if request.auth != null && get(/databases/$(database)/documents/teams/$(teamId)).data.owner == request.auth.uid;
      }
    }
  }
}
