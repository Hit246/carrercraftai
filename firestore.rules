rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read and update their own user document.
    // They can create their own user document on signup.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;

      // Users can manage their own resume versions.
      match /resumeVersions/{versionId} {
        allow get, list, create, update, delete: if request.auth.uid == userId;
      }
    }

    // Team management rules for 'recruiter' plan users.
    match /teams/{teamId} {
      // Team owner can read, update, and delete the team.
      allow get, update, delete: if request.auth.uid == resource.data.owner;
      // Any authenticated user with a 'recruiter' plan can create a team.
      allow create: if request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan == 'recruiter';

      // Rules for team members subcollection.
      match /members/{memberId} {
        // Team owner can add, view, and remove members.
        allow get, list, create, delete: if request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.owner;
      }
    }
    
    // Global settings for payments.
    match /settings/payment {
      // Allow any authenticated user to read payment settings.
      allow get: if request.auth.uid != null;
      // Disallow public writes. Only admin SDK should write to this.
      allow write: if false; 
    }

    // Support requests can be created by any authenticated user.
    match /supportRequests/{requestId} {
        allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
        // Only admin should be able to read/update/delete support requests.
        allow read, update, delete: if false;
    }
  }
}
