rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the requesting user is an admin
    function isAdmin() {
      return request.auth.token.email in ['admin@careercraft.ai', 'hitarth0236@gmail.com'];
    }
    
    // Helper function to check if the requesting user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // USERS Collection
    // Users can manage their own document. Admins can read/write any user data.
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // RESUMES Collection
    // A user can only read/write their own resume.
    match /resumes/{userId} {
      allow read, write: if isOwner(userId);
    }

    // TEAMS Collection
    match /teams/{teamId} {
      // Allow read if the user is a member of the team.
      // This is determined by checking the teamId field on the user's own document.
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
      
      // Allow write (e.g., creating the team) only by the owner.
      allow write: if resource.data.owner == request.auth.uid;

      // MEMBERS Subcollection
      match /members/{memberId} {
        // Any team member can read the list of other members.
        allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        
        // Only the team owner can add/remove members.
        allow write, delete: if get(/databases/$(database)/documents/teams/$(teamId)).data.owner == request.auth.uid;
      }
    }
    
    // SETTINGS Collection
    // Only admins can read or write to the settings.
    match /settings/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
