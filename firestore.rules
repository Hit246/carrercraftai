rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return request.auth.token.email in ['admin@careercraft.ai', 'hitarth0236@gmail.com'];
    }

    // Collection: users
    match /users/{userId} {
      // Anyone can create their own user document during signup
      allow create: if request.auth != null;

      // Users can only read and update their own data
      allow read, update: if isOwner(userId);

      // Admins can read/write any user's data
      allow read, write: if isAdmin();
      
      // Subcollection: resumeVersions
      match /resumeVersions/{versionId} {
        // Users can create, read, update, and delete their own resume versions
        allow read, write: if isOwner(userId);
      }
    }

    // Collection: teams
    match /teams/{teamId} {
        // Any authenticated user with a 'recruiter' plan can create a team
        // (Plan check should happen in backend logic before creation)
        allow create: if request.auth != null;
        
        // Team members can read team data.
        allow read: if exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;

        // Only the owner can update or delete the team document itself
        allow update, delete: if isOwner(get(/databases/$(database)/documents/teams/$(teamId)).data.owner);

        // Subcollection: members
        match /members/{memberId} {
            // Only the team owner can add/remove members
            allow write: if isOwner(get(/databases/$(database)/documents/teams/$(teamId)).data.owner);
            // All team members can read the member list
            allow read: if exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        }

        // Subcollection: candidates
        match /candidates/{candidateId} {
            // Team members can manage candidates
            allow read, write: if exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teamId == teamId;
        }
    }

    // Collection: settings
    match /settings/{settingId} {
      // Admins can read and write settings
      allow read, write: if isAdmin();
    }
    
    // Collection: supportRequests
    match /supportRequests/{requestId} {
      // Any authenticated user can create a support request
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Only admins can read support requests
      allow read: if isAdmin();
      // No one can update or delete support requests through the client
      allow update, delete: if false;
    }
  }
}
