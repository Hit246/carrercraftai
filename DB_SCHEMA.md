# CareerCraft AI - Firestore Database Schema

This document outlines the structure of the Firestore database used in the CareerCraft AI application.

## Collections

### 1. `users`

This collection stores information about individual users, their subscription status, and related metadata.

-   **Collection Path:** `/users`
-   **Document ID:** `user.uid` (The unique ID from Firebase Authentication)

#### Document Fields:

| Field                    | Type      | Description                                                                                               | Example                               |
| ------------------------ | --------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------- |
| `email`                  | `string`  | The user's email address.                                                                                 | `"user@example.com"`                  |
| `plan`                   | `string`  | The user's current subscription plan. Can be `free`, `essentials`, `pro`, `recruiter`, `pending`, `cancellation_requested`. | `"pro"`                               |
| `credits`                | `number`  | The number of AI credits available. Free: 5, Essentials: 50, Pro/Recruiter: Unlimited.                       | `50`                                  |
| `createdAt`              | `Timestamp` | The date and time when the user account was created.                                                      | `October 26, 2023 at 10:00:00 AM UTC+0` |
| `planUpdatedAt`          | `Timestamp` | The date and time when the user's plan was last updated (e.g., when an upgrade was approved).             | `November 1, 2023 at 12:30:00 PM UTC+0` |
| `requestedPlan`          | `string`  | The plan the user requested if their status is `pending`. Can be `essentials`, `pro` or `recruiter`.        | `"pro"`                               |
| `paymentProofURL`        | `string`  | The URL of the uploaded payment proof screenshot in Firebase Storage.                                     | `"https://firebasestorage.googleapis.com/..."` |
| `teamId`                 | `string`  | The ID of the team the user belongs to (primarily for `recruiter` plan users). Points to a doc in `teams`.  | `"T1a2b3c4d5"`                        |
| `hasCompletedOnboarding` | `boolean` | Set to `true` after the user has completed the initial guided tour. Defaults to `false`.                  | `true`                                |


#### Subcollection: `resumeVersions`

Each user document contains a subcollection of their resume versions. The number of versions a user can store is limited by their plan (Free: 2, Essentials: 10, Pro/Recruiter: Unlimited).

-   **Collection Path:** `/users/{userId}/resumeVersions`
-   **Document ID:** Auto-generated by Firestore.

##### Resume Version Document Fields:

| Field         | Type      | Description                                               |
|---------------|-----------|-----------------------------------------------------------|
| `versionName` | `string`  | The user-defined or AI-suggested name for this version.   |
| `updatedAt`   | `Timestamp` | The date and time this version was last saved.            |
| `resumeData`  | `Map`     | The complete, structured resume data for this version.      |


#### `resumeData` Object Structure:

The `resumeData` map contains the full content of a specific resume version.

| Field       | Type                 | Description                                                               |
| ----------- | -------------------- | ------------------------------------------------------------------------- |
| `name`      | `string`             | The full name of the user.                                                |
| `title`     | `string`             | The user's professional title (e.g., "Software Engineer").                |
| `phone`     | `string`             | The user's phone number.                                                  |
| `email`     | `string`             | The user's contact email.                                                 |
| `linkedin`  | `string`             | A link to the user's LinkedIn profile.                                    |
| `summary`   | `string`             | A professional summary or objective statement.                            |
| `skills`    | `string`             | A comma-separated list of skills.                                         |
| `experience`| `Array<Map>`         | An array of objects, where each object represents a work experience entry.|
| `education` | `Array<Map>`         | An array of objects, where each object represents an education entry.     |
| `projects`  | `Array<Map>`         | An array of objects, where each object represents a project showcase entry. |

##### `experience` Object Structure:

| Field         | Type     | Description                                           |
| ------------- | -------- | ----------------------------------------------------- |
| `id`          | `number` | A unique timestamp-based ID for the entry.            |
| `title`       | `string` | The job title.                                        |
| `company`     | `string` | The name of the company.                              |
| `dates`       | `string` | The employment dates (e.g., "2020 - Present").        |
| `description` | `string` | A description of responsibilities and achievements.   |

##### `education` Object Structure:

| Field    | Type     | Description                                           |
| -------- | -------- | ----------------------------------------------------- |
| `id`     | `number` | A unique timestamp-based ID for the entry.            |
| `school` | `string` | The name of the school or university.                 |
| `degree` | `string` | The degree obtained (e.g., "B.S. in Computer Science"). |
| `dates`  | `string` | The dates of attendance (e.g., "2016 - 2020").        |
| `cgpa`   | `string` | The Cumulative Grade Point Average (e.g., "8.5/10").  |

##### `projects` Object Structure:

| Field         | Type     | Description                                              |
| ------------- | -------- | -------------------------------------------------------- |
| `id`          | `number` | A unique timestamp-based ID for the entry.               |
| `name`        | `string` | The name of the project.                                 |
| `description` | `string` | A brief description of the project.                      |
| `url`         | `string` | A URL to the project (e.g., GitHub, live demo).          |
| `technologies`| `string` | Comma-separated list of technologies used in the project.|

---

### 2. `teams`

This collection stores information about teams created by users on the `recruiter` plan.

-   **Collection Path:** `/teams`
-   **Document ID:** Auto-generated by Firestore.

#### Document Fields:

| Field       | Type      | Description                                            |
| ----------- | --------- | ------------------------------------------------------ |
| `owner`     | `string`  | The `user.uid` of the user who owns/created the team.  |
| `createdAt` | `Timestamp` | The date and time the team was created.                |

#### Subcollection: `members`

Each team document contains a subcollection of its members.

-   **Collection Path:** `/teams/{teamId}/members`
-   **Document ID:** Auto-generated by Firestore.

##### Member Document Fields:

| Field     | Type     | Description                                             |
| --------- | -------- | ------------------------------------------------------- |
| `email`   | `string` | The email address of the invited team member.           |
| `role`    | `string` | The role of the member. Can be `Admin` or `Member`.     |
| `addedBy` | `string` | The email of the user who invited this member.          |

#### Subcollection: `candidates`

Each team document contains a subcollection of candidates that have been matched for jobs.

-   **Collection Path:** `/teams/{teamId}/candidates`
-   **Document ID:** Auto-generated by Firestore.

##### Candidate Document Fields:

| Field         | Type      | Description                                                               |
|---------------|-----------|---------------------------------------------------------------------------|
| `name`        | `string`  | The candidate's name, extracted from the resume.                          |
| `matchScore`  | `number`  | The AI-generated score (0-100) for a specific job description.            |
| `skills`      | `Array<string>` | An array of key skills extracted from the resume.                     |
| `status`      | `string`  | The candidate's status in the hiring pipeline. E.g., `New`, `Shortlisted`, `Interview`, `Hired`, `Rejected`. |
| `resumeURL`   | `string`  | A URL to the candidate's resume file in Firebase Storage.                 |
| `addedAt`     | `Timestamp` | The date and time the candidate was added.                                |
| `jobTitle`    | `string`  | The job title this candidate was matched against.                           |

---

### 3. `settings`

This collection is used for global application settings that can be configured by an administrator, such as payment details.

-   **Collection Path:** `/settings`
-   **Document ID:** `payment` (A singleton document)

#### Document Fields:

| Field            | Type     | Description                                        |
| ---------------- | -------- | -------------------------------------------------- |
| `upiId`          | `string` | The UPI ID to be displayed for payments.           |
| `qrCodeImageUrl` | `string` | The public URL of the QR code image for payments.  |

---

### 4. `supportRequests`

This collection stores all support requests submitted by users.

-   **Collection Path:** `/supportRequests`
-   **Document ID:** Auto-generated by Firestore.

#### Document Fields:

| Field           | Type      | Description                                                               |
| --------------- | --------- | ------------------------------------------------------------------------- |
| `userId`        | `string`  | The `user.uid` of the user who submitted the request.                     |
| `userEmail`     | `string`  | The email of the user who submitted the request.                          |
| `subject`       | `string`  | The subject of the support request.                                       |
| `category`      | `string`  | The category of the request (`billing`, `technical`, etc.).                 |
| `status`        | `string`  | The status of the request: `open`, `in-progress`, `closed`.               |
| `createdAt`     | `Timestamp` | The date and time the request was submitted.                              |
| `lastMessageAt` | `Timestamp` | The timestamp of the last message sent by either user or admin. For sorting. |

#### Subcollection: `history`

Each support request contains a subcollection for the conversation history.

-   **Collection Path:** `/supportRequests/{requestId}/history`
-   **Document ID:** Auto-generated by Firestore.

##### History Document Fields:

| Field       | Type      | Description                                               |
| ----------- | --------- | --------------------------------------------------------- |
| `message`   | `string`  | The content of the message.                               |
| `sender`    | `string`  | Who sent the message: `user` or `admin`.                  |
| `timestamp` | `Timestamp` | When the message was sent.                                |

---

## Entity Relationships (ER Diagram)

This section describes the relationships between the main collections in a text-based format.

1.  **Users ⟷ Resume Versions (One-to-Many, as a Subcollection)**
    *   A `user` can have multiple `resumeVersions`.
    *   **Relationship:** This is a direct parent-child relationship in Firestore, where `resumeVersions` documents are nested under a specific `user` document.

2.  **Users ⟷ Teams (One-to-Many)**
    *   A `user` with a `recruiter` plan can be the `owner` of one `team`.
    *   A `team` can have multiple `members` (who are also `users`).
    *   **Relationship:**
        *   The `teams` document contains an `owner` field which stores the `user.uid` of the creator.
        *   The `users` document contains a `teamId` field, which links a user to the `team` document they are a member of.

3.  **Teams ⟷ Members (One-to-Many, as a Subcollection)**
    *   A `team` document contains a `members` subcollection.
    *   Each document in the `members` subcollection represents an invited user.
    *   **Relationship:** This is a direct parent-child relationship in Firestore, where `members` documents are nested under a specific `team`.

4.  **Teams ⟷ Candidates (One-to-Many, as a Subcollection)**
    *   A `team` document contains a `candidates` subcollection.
    *   Each document in the `candidates` subcollection represents a candidate who was matched against a job.
    *   **Relationship:** This is a direct parent-child relationship where `candidates` documents are nested under a specific `team`.

5.  **Settings (Singleton)**
    *   The `settings` collection is not directly related to any other collection. It contains singleton documents (like `payment`) for storing global application configuration that is managed by an admin.

6.  **Users ⟷ Support Requests (One-to-Many)**
    *   A `user` can have multiple `supportRequests`.
    *   **Relationship:** The `supportRequests` document contains a `userId` field linking it back to the `users` document.

7.  **Support Requests ⟷ History (One-to-Many, as a Subcollection)**
    *   A `supportRequest` can have multiple `history` entries.
    *   **Relationship:** This is a direct parent-child relationship where `history` documents are nested under a specific `supportRequest`.

---

## Data Flow Diagram (DFD) Explanation

This section provides a text-based description of the primary data flows within the CareerCraft AI application.

### Process 1: User Registration & Authentication

-   **External Entity:** User, Admin
-   **Processes:**
    1.  **User Signup:** A new user provides `email` and `password`. The system creates an account in **Firebase Auth** and a corresponding document in the `users` collection with `plan: 'free'`, `credits: 5`, and `hasCompletedOnboarding: false`.
    2.  **User Login:** A user provides `email` and `password`. The system verifies credentials against **Firebase Auth**. Upon success, it fetches user data from the `users` collection to determine their plan and permissions.
-   **Data Stores:**
    -   **`Firebase Auth`**: Stores and manages user credentials.
    -   **`users` Collection**: Stores application-specific user data like plan, credits, etc.
-   **Data Flows:**
    -   `User Credentials` -> `Login/Signup UI` -> `Firebase Auth`
    -   `User Profile Data` -> `users` Collection -> `Application UI`

### Process 2: Resume Management

-   **External Entity:** User
-   **Processes:**
    1.  **Load Resume Versions:** When the user visits the builder, the system fetches all documents from the `users/{userId}/resumeVersions` subcollection.
    2.  **Select & Edit Resume:** The user selects a version to edit from a dropdown. The data is loaded into the **Resume Builder UI**.
    3.  **Save Current Version:** On clicking "Save," the system updates the currently loaded resume version document in the `resumeVersions` subcollection.
    4.  **Save as New Version:** On clicking "Save as New," the system creates a new document in the `resumeVersions` subcollection with the current form data, if the user is within their plan's draft limit.
-   **Data Store:**
    -   **`users/{userId}/resumeVersions` Subcollection**: Stores the structured content of each resume version.
-   **Data Flows:**
    -   `Resume Form Data` -> `Resume Builder UI` -> `resumeVersions` Subcollection
    -   `Resume Version Document` -> `resumeVersions` Subcollection -> `Resume Builder UI` & `Live Preview`

### Process 3: AI Feature Usage (e.g., Resume Analyzer)

-   **External Entity:** User
-   **Processes:**
    1.  **Submit for Analysis:** The user uploads a resume file (`.pdf`, `.docx`) via the **Resume Analyzer UI**.
    2.  **Credit Check:** The system checks if the user's `credits` in the `users` document is greater than 0 or if they have an unlimited plan.
    3.  **Call AI Flow:** The system sends the resume file to the `analyzeResume` Genkit flow.
    4.  **Decrement Credit:** If the user is on a credit-limited plan, the system updates the `users` document to decrement the `credits` count.
    5.  **Display Results:** The AI-generated analysis is returned and displayed on the UI.
-   **Data Stores:**
    -   **`users` Collection**: Read for credit check, written to for credit decrement.
-   **Data Flows:**
    -   `Resume File` -> `AI Feature UI` -> `Genkit AI Flow`
    -   `Credits Count` -> `users` Collection -> `System Logic`
    -   `AI Analysis JSON` -> `Genkit AI Flow` -> `AI Feature UI`

### Process 4: Subscription Upgrade (User & Admin Interaction)

-   **External Entities:** User, Admin
-   **Processes:**
    1.  **Request Upgrade:** The user selects a plan from the **Pricing Page**. The system shows a **Payment Dialog**.
    2.  **Fetch Payment Details:** The dialog fetches `upiId` and `qrCodeImageUrl` from the `settings` collection.
    3.  **Confirm Payment:** The user clicks "I have paid." The system updates the user's document in the `users` collection to `plan: 'pending'` and sets the `requestedPlan`.
    4.  **Upload Proof:** The user is redirected to the **Profile Page**, where they upload a payment proof image. This image is saved to **Firebase Storage**, and the URL is stored in the `paymentProofURL` field in their `users` document.
    5.  **Admin Review:** The **Admin Panel** queries the `users` collection for all users with `plan: 'pending'`. The admin reviews the `paymentProofURL`.
    6.  **Approve/Reject:** The admin approves or rejects the request. The system updates the user's document in the `users` collection to the `requestedPlan` (e.g., 'pro') or back to their previous plan.
-   **Data Stores:**
    -   **`users` Collection**: Manages the user's state through the upgrade process.
    -   **`settings` Collection**: Provides payment details to the user.
    -   **`Firebase Storage`**: Stores the payment proof images.
-   **Data Flows:**
    -   `Payment Details` -> `settings` Collection -> `Payment Dialog`
    -   `Upgrade Request` -> `Pricing Page` -> `users` Collection
    -   `Payment Proof Image` -> `Profile Page` -> `Firebase Storage`
    -   `Payment Proof URL` -> `Firebase Storage` -> `users` Collection
    -   `Pending Requests` -> `users` Collection -> `Admin Panel`
    -   `Approval/Rejection` -> `Admin Panel` -> `users` Collection

### Process 5: Candidate Management (Recruiter)

-   **External Entity:** Recruiter
-   **Processes:**
    1.  **Match Candidates:** Recruiter uses the **Candidate Matcher** tool, uploading a job description and multiple resumes.
    2.  **Save Candidates:** The `candidateMatcher` flow processes the resumes, extracts details, calculates a score, and saves each candidate as a new document in the `/teams/{teamId}/candidates` subcollection with a status of `New`. The resume file is uploaded to Firebase Storage.
    3.  **View Dashboard:** Recruiter navigates to the **Candidate Management** dashboard. The system queries all documents from the `/teams/{teamId}/candidates` subcollection.
    4.  **Filter & Update Status:** Recruiter can filter the list (e.g., by job title) and update a candidate's status (e.g., from `New` to `Shortlisted`) by interacting with the UI. The system updates the corresponding candidate document in Firestore.
-   **Data Stores:**
    -   **`/teams/{teamId}/candidates` Subcollection**: Stores and manages the recruiter's talent pool.
    -   **`Firebase Storage`**: Stores the candidate resume files.
-   **Data Flows:**
    -   `Resume Files` -> `Candidate Matcher UI` -> `candidateMatcher` Flow -> `candidates` Subcollection & `Firebase Storage`
    -   `Candidate List` -> `candidates` Subcollection -> `Candidate Dashboard UI`
    -   `Status Update` -> `Candidate Dashboard UI` -> `candidates` Subcollection

### Process 6: Support Ticket Management

-   **External Entities:** User, Admin
-   **Processes:**
    1.  **User Submits Ticket:** A user fills out the support form. The system creates a new document in the `supportRequests` collection with `status: 'open'` and adds the user's message to a `history` subcollection.
    2.  **Admin Views Tickets:** An admin goes to the **Support Panel**. The system queries all documents from the `supportRequests` collection, sorted by `lastMessageAt`.
    3.  **Admin Responds:** The admin opens a ticket, views the history, and submits a reply. The system adds the admin's message to the `history` subcollection and updates the ticket's `status` to `in-progress` and `lastMessageAt`.
    4.  **User Views History:** The user visits the **Support Page**. The system queries all tickets for that `userId`. The user can view the conversation history, including the admin's reply.
-   **Data Stores:**
    -   **`supportRequests` Collection**: Stores the main ticket metadata.
    -   **`/supportRequests/{requestId}/history` Subcollection**: Stores the conversation messages.
-   **Data Flows:**
    -   `Support Message` -> `Support UI` -> `supportRequests` & `history` Collections
    -   `Support Tickets List` -> `supportRequests` Collection -> `Admin Panel`
    -   `Admin Reply` -> `Admin Panel` -> `history` Collection
    -   `Conversation History` -> `history` Subcollection -> `Support UI` & `Admin Panel`
